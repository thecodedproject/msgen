package rpc_server

import(
	"github.com/thecodedproject/msgen/generator/files/common"
	"github.com/thecodedproject/msgen/parser"
	"github.com/thecodedproject/msgen/parser/proto_helpers"
	"io"
	"path"
)

const(
	relativePath = "rpc_server/server.go"
)

type Method struct {
	Name string
	Args []parser.Field
	ReturnArgs []parser.Field
	ProtoPackage string
}

func Generate(
	serviceRootImportPath string,
	i parser.ProtoInterface,
	outputDir string,
) error {

	outputFile := path.Join(outputDir, relativePath)

	writer, err := common.CreatePathAndOpen(outputFile)
	if err != nil {
		return err
	}

	return GenerateBuffer(
		serviceRootImportPath,
		i,
		writer,
	)
}

func GenerateBuffer(
	serviceRootImportPath string,
	i parser.ProtoInterface,
	writer io.Writer,
) error {

	serviceName := common.ServiceNameFromRootImportPath(serviceRootImportPath)

	baseTemplate := common.BaseTemplate(serviceName)

	header, err := baseTemplate.Parse(testHeaderTmpl)
	if err != nil {
		return err
	}

	err = header.Execute(writer, struct{
		Package string
		Imports []string
	}{
		Package: "rpc_server",
		Imports: []string{
			"\"context\"",
			"\"" + serviceRootImportPath + "/ops\"",
			"\"" + serviceRootImportPath + "/state\"",
			"\"" + serviceRootImportPath + "/" + i.ProtoPackage + "\"",
		},
	})
	if err != nil {
		return err
	}

	for _, method := range i.Methods {

		args, err := proto_helpers.MethodRequestFields(i, method.Name)
		if err != nil {
			return err
		}

		returnArgs, err := proto_helpers.MethodResponseFields(i, method.Name)
		if err != nil {
			return err
		}

		methodParams := Method{
			Name: method.Name,
			Args: args,
			ReturnArgs: returnArgs,
			ProtoPackage: i.ProtoPackage,
		}

		methodTemplate, err := baseTemplate.Parse(testMethodTmpl)
		if err != nil {
			return err
		}

		err = methodTemplate.Execute(writer, methodParams)
		if err != nil {
			return err
		}
	}

	return nil
}

var testHeaderTmpl = `package {{.Package}}

// Generated by msgen. DO NOT EDIT.

import(
{{- range .Imports}}
	{{.}}
{{- end}}
)

type Server struct {
	st state.State
}

func New(st state.State) *Server {
	return &Server{
		st: st,
	}
}

`

var testMethodTmpl = `
{{- $protoPackage := .ProtoPackage -}}
func (s *Server) {{ToCamel .Name}}(
	ctx context.Context,
	req *{{$protoPackage}}.{{ToCamel .Name}}Request,
) (*{{$protoPackage}}.{{ToCamel .Name}}Response, error) {

	{{range .ReturnArgs}}{{ToLowerCamel .Name}}, {{end}}err := ops.{{ToCamel .Name}}(
		ctx,
		s.st,
{{- range .Args}}
{{- if .IsNestedMessage}}
		{{$protoPackage}}.{{.Type}}FromProto(req.{{ToCamel .Name}}),
{{- else}}
		req.{{ToCamel .Name}},
{{- end}}
{{- end}}
	)
	if err != nil {
		return nil, err
	}

	return &{{$protoPackage}}.{{ToCamel .Name}}Response{
{{- range .ReturnArgs}}
{{- if .IsNestedMessage}}
		{{ToCamel .Name}}: {{$protoPackage}}.{{.Type}}ToProto({{ToLowerCamel .Name}}),
{{- else}}
		{{ToCamel .Name}}: {{ToLowerCamel .Name}},
{{- end}}
{{- end}}
	}, nil
}

`


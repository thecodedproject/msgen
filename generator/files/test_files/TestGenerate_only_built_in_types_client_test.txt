package client_test

// Generated by msgen. DO NOT EDIT.

import(
	"context"
	"github.com/stretchr/testify/suite"
	"google.golang.org/grpc"
	"google.golang.org/grpc/connectivity"
	"some/service"
	"some/service/servicepb"
	"some/service/ops"
	"some/service/rpc_server"
	logical_client "some/service/client/logical"
	grpc_client "some/service/client/grpc"
	"testing"
	"time"
	"net"
	"log"
)

func setupGRPCServer(s *TestGRPCSuite, b ops.Backends) (string) {

	listener, err := net.Listen("tcp", "localhost:0")
	s.Require().NoError(err)

	grpcSrv := grpc.NewServer()
	s.T().Cleanup(grpcSrv.GracefulStop)

	serviceSrv := rpc_server.New(b)
	servicepb.RegisterServiceServer(grpcSrv, serviceSrv)

	go func() {
		err := grpcSrv.Serve(listener)
		s.Require().NoError(err)
	}()

	return listener.Addr().String()
}

func setupGRPCClient(s *TestGRPCSuite, b ops.Backends) service.Client {

	serverAddr := setupGRPCServer(s, b)
	conn, err := grpc.Dial(serverAddr, grpc.WithInsecure())
	s.Require().NoError(err)

	ctx, cancel := context.WithTimeout(context.Background(), time.Second)
	defer cancel()

	for {
		if conn.GetState() == connectivity.Ready {
			break
		}

		if !conn.WaitForStateChange(ctx, conn.GetState()) {
			log.Fatal("grpc timeout whilst connecting")
		}
	}

	client := grpc_client.NewForTesting(s.T(), conn)
	return client
}


type clientSuite struct {
	suite.Suite

	createClient func(b ops.Backends) service.Client
}

func TestLogical(t *testing.T) {
	suite.Run(t, new(TestLogicalSuite))
}

func TestGRPC(t *testing.T) {
	suite.Run(t, new(TestGRPCSuite))
}

type TestLogicalSuite struct {
	clientSuite
}

func (s *TestLogicalSuite) SetupTest() {
	s.createClient = func(b ops.Backends) service.Client {
		return logical_client.New(b)
	}
}

type TestGRPCSuite struct {
	clientSuite
}

func (s *TestGRPCSuite) SetupTest() {
	s.createClient = func(b ops.Backends) service.Client {
		return setupGRPCClient(s, b)
	}
}

func (s *clientSuite) TestPing() {

	testCases := []struct{
		Name string
	}{
		{
			Name: "some_test",
		},
	}

	for _, test := range testCases {
		s.T().Run(test.Name, func(t *testing.T) {

			c := s.createClient(
				ops.NewBackendsForTesting(
					t,
				),
			)

			ctx := context.Background()
			var int64Value int64
			var stringValue string
			var err error
			err = c.Ping(
				ctx,
				int64Value,
				stringValue,
			)
			s.Require().NoError(err)

			s.Assert().Fail("TODO: Implement test for client.Ping")
		})
	}
}

func (s *clientSuite) TestPong() {

	testCases := []struct{
		Name string
	}{
		{
			Name: "some_test",
		},
	}

	for _, test := range testCases {
		s.T().Run(test.Name, func(t *testing.T) {

			c := s.createClient(
				ops.NewBackendsForTesting(
					t,
				),
			)

			ctx := context.Background()
			var err error
			_, _, err = c.Pong(
				ctx,
			)
			s.Require().NoError(err)

			s.Assert().Fail("TODO: Implement test for client.Pong")
		})
	}
}

